name: Cleanup Old Artifacts

permissions:
  actions: write
  contents: read

on:
  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨è¿è¡Œ
  schedule:
    - cron: '0 2 * * *'
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'ä¿ç•™å¤©æ•° (é»˜è®¤: 7å¤©)'
        required: false
        default: '7'
        type: string
      dry_run:
        description: 'ä»…é¢„è§ˆï¼Œä¸å®é™…åˆ é™¤'
        required: false
        default: false
        type: boolean

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // è·å–è¾“å…¥å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
            const retentionDays = parseInt('${{ github.event.inputs.retention_days }}' || '7');
            const dryRun = '${{ github.event.inputs.dry_run }}' === 'true';
            
            console.log(`ğŸ§¹ å¼€å§‹æ¸…ç† artifacts...`);
            console.log(`ğŸ“… ä¿ç•™å¤©æ•°: ${retentionDays} å¤©`);
            console.log(`ğŸ” é¢„è§ˆæ¨¡å¼: ${dryRun ? 'æ˜¯' : 'å¦'}`);
            console.log('');
            
            // è·å–æ‰€æœ‰ artifacts
            let allArtifacts = [];
            let page = 1;
            
            while (true) {
              const response = await github.rest.actions.listArtifactsForRepo({
                owner: owner,
                repo: repo,
                per_page: 100,
                page: page
              });
              
              if (response.data.artifacts.length === 0) {
                break;
              }
              
              allArtifacts = allArtifacts.concat(response.data.artifacts);
              page++;
            }
            
            console.log(`ğŸ“¦ æ‰¾åˆ° ${allArtifacts.length} ä¸ª artifacts`);
            
            // è®¡ç®—æˆªæ­¢æ—¶é—´
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - retentionDays);
            
            console.log(`ğŸ—“ï¸  åˆ é™¤ ${cutoffDate.toISOString()} ä¹‹å‰åˆ›å»ºçš„ artifacts`);
            console.log('');
            
            // ç­›é€‰éœ€è¦åˆ é™¤çš„ artifacts
            const artifactsToDelete = allArtifacts.filter(artifact => {
              const createdAt = new Date(artifact.created_at);
              return createdAt < cutoffDate;
            });
            
            if (artifactsToDelete.length === 0) {
              console.log('âœ… æ²¡æœ‰éœ€è¦æ¸…ç†çš„ artifacts');
              return;
            }
            
            console.log(`ğŸ—‘ï¸  æ‰¾åˆ° ${artifactsToDelete.length} ä¸ªéœ€è¦åˆ é™¤çš„ artifacts:`);
            
            let deletedCount = 0;
            let failedCount = 0;
            let totalSize = 0;
            
            for (const artifact of artifactsToDelete) {
              const createdAt = new Date(artifact.created_at);
              const ageInDays = Math.floor((Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24));
              const sizeInMB = (artifact.size_in_bytes / (1024 * 1024)).toFixed(2);
              
              totalSize += artifact.size_in_bytes;
              
              console.log(`  ğŸ“„ ${artifact.name}`);
              console.log(`     ID: ${artifact.id}`);
              console.log(`     åˆ›å»ºæ—¶é—´: ${createdAt.toISOString()}`);
              console.log(`     å¹´é¾„: ${ageInDays} å¤©`);
              console.log(`     å¤§å°: ${sizeInMB} MB`);
              
              if (!dryRun) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: owner,
                    repo: repo,
                    artifact_id: artifact.id
                  });
                  console.log(`     âœ… åˆ é™¤æˆåŠŸ`);
                  deletedCount++;
                } catch (error) {
                  console.log(`     âŒ åˆ é™¤å¤±è´¥: ${error.message}`);
                  failedCount++;
                }
              } else {
                console.log(`     ğŸ” é¢„è§ˆæ¨¡å¼ - å°†è¢«åˆ é™¤`);
                deletedCount++;
              }
              console.log('');
            }
            
            const totalSizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            
            console.log('ğŸ“Š æ¸…ç†ç»Ÿè®¡:');
            console.log(`   æ€»è®¡ artifacts: ${allArtifacts.length}`);
            console.log(`   éœ€è¦åˆ é™¤: ${artifactsToDelete.length}`);
            console.log(`   ${dryRun ? 'é¢„è®¡' : 'å®é™…'}åˆ é™¤: ${deletedCount}`);
            if (!dryRun && failedCount > 0) {
              console.log(`   åˆ é™¤å¤±è´¥: ${failedCount}`);
            }
            console.log(`   ${dryRun ? 'é¢„è®¡' : 'å®é™…'}é‡Šæ”¾ç©ºé—´: ${totalSizeInMB} MB`);
            
            if (dryRun) {
              console.log('');
              console.log('ğŸ’¡ è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œæ²¡æœ‰å®é™…åˆ é™¤ä»»ä½•æ–‡ä»¶');
              console.log('   è¦æ‰§è¡Œå®é™…åˆ é™¤ï¼Œè¯·å°† "ä»…é¢„è§ˆï¼Œä¸å®é™…åˆ é™¤" è®¾ç½®ä¸º false');
            }